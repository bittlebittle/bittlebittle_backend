<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="userMapper">


    <resultMap id="userResultSet" type="user">
        <result property="userNo" column="USER_NO_PK" />
        <result property="userId" column="USER_ID" />
        <result property="userPwd" column="USER_PWD" />
        <result property="userName" column="USER_NAME" />
        <result property="nickname" column="NICKNAME" />
        <result property="email" column="EMAIL" />
        <result property="phone" column="PHONE" />
        <result property="status" column="STATUS" />
        <result property="adminYn" column="ADMIN_YN" />
    </resultMap>

    <resultMap id="userJwtResultSet" type="userJwt">
        <result property="userJwtIdx" column="USER_JWT_IDX_PK" />
        <result property="userNo" column="USER_NO_Fk" />
        <result property="refreshToken" column="REFRESH_TOKEN" />
    </resultMap>

    <insert id="insert" parameterType="user">
        INSERT INTO USER_TB VALUES (#{userId})
    </insert>

    <select id="selectOne" parameterType="user" resultMap="userResultSet">
        SELECT user_id, user_pwd, nickname
        FROM USER_TB
        <where>
            <if test="userNo != null and userNo != 0">user_no_pk = #{userNo}</if>
            <if test="userId != null and userId != ''">user_id = #{userId}</if>
        </where>
    </select>

    <select id="selectLoginUser" parameterType="user" resultMap="userResultSet">
        SELECT user_id, user_pwd, nickname
        FROM USER_TB
        <where>
            <if test="userId != null and userId != ''">user_id = #{userId}</if>
        </where>
    </select>

    <select id="selectList" resultType="user" resultMap="userResultSet">
        select *
        from USER_TB;
    </select>

    <select id="selectUserJwt" parameterType="userJwt" resultMap="userJwtResultSet">
        SELECT *
        FROM USER_JWT_TB
        WHERE USER_JWT_IDX_PK = #{userJwtIdx}
    </select>

    <select id="selectUserJwtBySubject" parameterType="userJwt" resultMap="userJwtResultSet">
        SELECT UJ.*
        FROM USER_JWT_TB UJ
            JOIN USER_TB U
        WHERE U.USER_NO_PK = UJ.USER_NO_FK
          AND U.USER_ID = #{subject}
    </select>

    <insert id="insertJwtWithIdx" parameterType="userJwt">
        INSERT INTO USER_JWT_TB (`USER_JWT_IDX_PK`, `USER_NO_Fk`, `REFRESH_TOKEN`)
        SELECT #{userJwtIdx}, USER_NO_PK, #{refreshToken}
            FROM USER_TB
            WHERE USER_ID = #{subject}
    </insert>

    <update id="updateUserJwtWithIdx" parameterType="userJwt">
        UPDATE USER_JWT_TB
        SET REFRESH_TOKEN = #{refreshToken}
        WHERE USER_JWT_IDX_PK = #{userJwtIdx}
    </update>

    <delete id="deleteUserJwtWithSubject" parameterType="userJwt">
        DELETE UJ
        FROM USER_JWT_TB UJ
        JOIN USER_TB U
        ON UJ.USER_NO_FK = U.USER_NO_PK
        <where>
            <if test="subject != null and subject != ''">U.USER_ID = #{subject}</if>
            <if test="userJwtIdx != null and userJwtIdx != ''">UJ.USER_JWT_IDX_PK = #{userJwtIdx}</if>
        </where>
    </delete>

    <delete id="deleteUserJwtWithUserJwtIdx" parameterType="userJwt">
        DELETE
        FROM USER_JWT_TB
        WHERE USER_JWT_IDX_PK = #{userJwtIdx}
    </delete>

</mapper>
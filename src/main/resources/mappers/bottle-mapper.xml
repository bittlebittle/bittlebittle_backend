<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bottleMapper">

   <resultMap id="bottleResultSet" type="bottle">
      <result property="bottleNo" column="BOTTLE_NO_PK"/>
      <result property="bottleName" column="BOTTLE_NAME"/>
      <result property="bottleContent" column="BOTTLE_CONTENT" />
      <result property="bottleBrand" column="BOTTLE_BRAND" />
      <result property="bottleAbv" column="BOTTLE_ABV" />
      <result property="viewCnt" column="VIEW_CNT" />
      <result property="createDate" column="CREATE_DATE" jdbcType="TIME" javaType="String" />
      <result property="imgUrl" column="IMG_URL" />
      <result property="imgCusUrl" column="IMG_CUS_URL" />
      <result property="status" column="STATUS" />
   </resultMap>

   <select id="selectOne" parameterType="Integer" resultMap="bottleResultSet">
         SELECT *
         FROM bottle_tb
         WHERE BOTTLE_NO_PK=#{bottleNo}
   </select>
   
   <update id="updateViewCnt" parameterType="Integer">
       <![CDATA[   
         UPDATE bottle_tb
         SET VIEW_CNT=VIEW_CNT+1
         WHERE bottle_no_pk=#{bottleNo}
      ]]>
   </update>
   

   <select id="selectRelated" parameterType="Integer" resultMap="bottleResultSet">
       <![CDATA[   
        SELECT BOTTLE_NAME, IMG_URL
		FROM bottle_tag_tb bt
		INNER JOIN bottle_tb b
		ON b.bottle_no_pk=bt.bottle_no_fk
		WHERE tag_no_fk in (
		SELECT tag_no_fk
		FROM bottle_tb b
		INNER JOIN bottle_tag_tb bt
		ON b.bottle_no_pk=bt.bottle_no_fk
		WHERE b.bottle_no_pk=#{bottleNo}) AND b.STATUS = 'Y'
		AND bt.bottle_no_fk != #{bottleNo}
		GROUP BY bottle_no_fk
		ORDER BY count(tag_no_fk) DESC
		LIMIT 5
		
      ]]>
   </select>

   <insert id="insertOne" parameterType="bottleInfo">
    <![CDATA[   
         INSERT INTO bottle_tb(BOTTLE_NAME, BOTTLE_CONTENT, BOTTLE_BRAND, BOTTLE_ABV, IMG_URL)
         VALUES(#{bottleName}, #{bottleContent}, #{bottleBrand}, #{bottleAbv}, #{imgUrl})
     ]]>
   </insert>
   
  
    <update id="updateOne" parameterType="bottle">
       <![CDATA[   
         UPDATE bottle_tb
         SET BOTTLE_NAME=#{bottleName}, BOTTLE_CONTENT=#{bottleContent}, BOTTLE_BRAND=#{bottleBrand}, BOTTLE_ABV=#{bottleAbv}, IMG_URL=#{imgUrl}
         WHERE BOTTLE_NO_PK=#{bottleNo}
      ]]>
   </update>
	
    <select id="selectAll" resultType="bottle" resultMap="bottleResultSet">
        SELECT bottle_name
        FROM bottle_tb
        <if test="keyword != null">
            WHERE bottle_name LIKE CONCAT('%', #{Keyword},' %')
        </if>
    </select>

    <!--  태그 선택과 키워드 조회가 동시에 가능한 동적쿼리 -->
    <!--  parameterType, collection에는 뭐 들어가는지 더 알아봐야함 -->
    <select id="selectBottles" parameterType="bottle" resultMap="bottleResultSet">
        SELECT b.bottle_no_pk, b.bottle_name, b.bottle_content, b.bottle_brand, b.bottle_abv,
        GROUP_CONCAT(t.tag_name ORDER BY t.tag_name SEPARATOR ', ') AS tag_names
        FROM bottle_tb b
        JOIN BOTTLE_TAG_TB bt ON b.bottle_no_pk = bt.bottle_no_fk
        JOIN tag_tb t ON t.tag_no_pk = bt.tag_no_fk
        WHERE b.bottle_name IS NOT NULL
        <if test="tag_name != null" >
            AND t.tag_name IN
            <foreach collection="String" item="tag_name" separator="," open="(" close=")">
                #{tag_name}
            </foreach>
        </if>

        <if test="keyword != null">
            AND bottle_name LIKE CONCAT('%', #{keyword}, '%')
        </if>

        GROUP BY b.bottle_no_pk
        HAVING COUNT(DISTINCT t.tag_name) = #{parameter.size()}
    </select>


	<update id="deleteOne" parameterType="Integer">
       <![CDATA[   
         UPDATE bottle_tb
         SET STATUS='N'
         WHERE bottle_no_pk=#{bottleNo}
      ]]>
   </update>
   
     <select id="selectLastBottleNo" resultType="Integer">
        SELECT MAX(bottle_no_pk)
        FROM bottle_tb
    </select>
   
    </mapper>